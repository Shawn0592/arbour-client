var TUTORIAL_MAP = {
	"A1": {"movable": false, "tile": "1_2", "hero": false, "hero_by_player": null, "hero_number": null},
	"A2": {"movable": false, "tile": "2_3", "hero": false, "hero_by_player": null, "hero_number": null},
	"A3": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"A4": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"A5": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"A6": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"A7": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"A8": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"A9": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"B1": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"B2": {"movable": false, "tile": "2_1", "hero": false, "hero_by_player": null, "hero_number": null},
	"B3": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"B4": {"movable": false, "tile": "2_1", "hero": false, "hero_by_player": null, "hero_number": null},
	"B5": {"movable": false, "tile": "1_2", "hero": false, "hero_by_player": null, "hero_number": null},
	"B6": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"B7": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"B8": {"movable": false, "tile": "1_1", "hero": false, "hero_by_player": null, "hero_number": null},
	"B9": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"C1": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"C2": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"C3": {"movable": false, "tile": "2_2", "hero": false, "hero_by_player": null, "hero_number": null},
	"C4": {"movable": false, "tile": "2_1", "hero": false, "hero_by_player": null, "hero_number": null},
	"C5": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"C6": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"C7": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"C8": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"C9": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"D1": {"movable": false, "tile": "1_3", "hero": false, "hero_by_player": null, "hero_number": null},
	"D2": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"D3": {"movable": false, "tile": "1_2", "hero": false, "hero_by_player": null, "hero_number": null},
	"D4": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"D5": {"movable": false, "tile": "1_3", "hero": false, "hero_by_player": null, "hero_number": null},
	"D6": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"D7": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"D8": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"D9": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"E1": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"E2": {"movable": false, "tile": "1_3", "hero": false, "hero_by_player": null, "hero_number": null},
	"E3": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"E4": {"movable": false, "tile": "2_2", "hero": false, "hero_by_player": null, "hero_number": null},
	"E5": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"E6": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"E7": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"E8": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"E9": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"F1": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"F2": {"movable": false, "tile": "1_1", "hero": false, "hero_by_player": null, "hero_number": null},
	"F3": {"movable": false, "tile": "2_1", "hero": false, "hero_by_player": null, "hero_number": null},
	"F4": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"F5": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"F6": {"movable": false, "tile": "1_3", "hero": false, "hero_by_player": null, "hero_number": null},
	"F7": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"F8": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null},
	"F9": {"movable": true, "tile": 0, "hero": false, "hero_by_player": null, "hero_number": null}
};

function drawTutorialMap(){
	var row, col, _row;
	document.getElementsByTagName('svg')[1].innerHTML = ``;

	for(var i in TUTORIAL_MAP){
		row = i[0];
		if(row == 'A'){ _row = 1; } else if(row == 'B'){ _row = 2; } else if(row == 'C'){ _row = 3; } else if(row == 'D'){ _row = 4; } else if(row == 'E'){ _row = 5; } else if(row == 'F'){ _row = 6; }
		col = i[1];
		var _x = 38;
		var del_x = 0;
		var y = (_row*34)+35;

		var x = (col*_x)-35;

		if(row == 'B' || row == 'D' || row == 'F'){
			del_x = 21.5;
			x = ((col*_x)+del_x)-38;
		}

		document.getElementsByTagName('svg')[1].innerHTML = document.getElementsByTagName('svg')[1].innerHTML + `<image overflow="visible" width="613" height="718" id="tutorial-`+i+`" onclick="map_click('`+i+`')" xlink:href="assets/map/tile`+TUTORIAL_MAP[i].tile+`.png" transform="matrix(0.0655 0 0 0.0655 `+x+` `+y+`)">
			</image>`;
	}

	for(var i in TUTORIAL_MAP){
		if(TUTORIAL_MAP[i].movable == false){
			document.getElementById('tutorial-'+i).href.baseVal = 'assets/map/tile'+TUTORIAL_MAP[i].tile+'.png';
			$('#'+i).addClass('map-blocked-item');
		} else if(TUTORIAL_MAP[i].movable == true && TUTORIAL_MAP[i].tile == 0){
			// var x, y;
			// x = document.getElementById(i).transform.animVal[0].matrix.e+13;
			// y = document.getElementById(i).transform.animVal[0].matrix.f+27;

			// document.getElementsByTagName('svg')[1].innerHTML = document.getElementsByTagName('svg')[1].innerHTML + `
			// 	<text x="`+x+`" y="`+y+`" style="fill:#C3B58D;font-weight:400;font-size:12px;" class="map-text">`+i+`</text>`;
			
			$('#'+i).addClass('map-item');
		}
	}
}

function drawTutorialMenu(){
  for(var i = 1; i <= 6; i++){
    var el = document.getElementById('magic-tutorial-'+i);
    el.src = 'assets/img/magic/fire/'+i+'.svg';

    var description = '';
    if(i == 1){ description = `Наносит противнику на ближайшей клетке <span class="red">${MAGIC["fire"][i-1].damage}</span> единицу урона` }
    if(i == 2){ description = `Восстанавливает <span class="danger">${MAGIC["fire"][i-1].add_heal}</span> здоровья и <span class="primary">${MAGIC["fire"][i-1].add_magic}</span> маны` }
    if(i == 3){ description = `Наносит противнику на ближайшей клетке <span class="red">${MAGIC["fire"][i-1].magic_damage}</span> единиц магического урона` }
    if(i == 4){ description = `Наносит противнику на ближайшей клетке <span class="red">${MAGIC["fire"][i-1].damage}</span> единиц урона` }
    if(i == 5){ description = `Наносит противнику на ближайшей клетке <span class="red">${MAGIC["fire"][i-1].magic_damage}</span> единиц магического урона` }
    if(i == 6){ description = `Наносит противнику на ближайшей клетке <span class="red">${MAGIC["fire"][i-1].damage}</span> единиц урона и восстанавливает <span class="danger">${MAGIC["fire"][i-1].add_heal}</span> здоровья и <span class="primary">${MAGIC["fire"][i-1].add_magic}</span> маны` }

    var doc = document.getElementById('button-tutorial-'+i)
    doc.title = `<b>${MAGIC["fire"][i-1].name}</b><p>${description}</p>`

	document.getElementsByClassName('block-tutorial')[1].style.bottom = '10px'; // 1
	document.getElementsByClassName('block-tutorial')[2].style.bottom = '10px'; // 2
	document.getElementsByClassName('block-tutorial')[3].style.bottom = '10px'; // 3
	document.getElementsByClassName('block-tutorial')[4].style.bottom = '10px'; // 4
	document.getElementsByClassName('block-tutorial')[5].style.bottom = '10px'; // 5
	document.getElementsByClassName('block-tutorial')[6].style.bottom = '10px'; // 6
  }
}

var tutorial_step = 0;
var tutorial_enemy_tile;
function tutorial(step){
	tutorial_mode = true;
	$('#judge-text').typed('reset'); $('#judge-text').text('...');

	$("#judge-text").typed({
		strings: [TUTORIAL_SCENES[step].text],
		stringsElement: null,
		typeSpeed: 40,
		startDelay: 1200,
		backSpeed: 20,
		backDelay: 500,
		loop: false,
		loopCount: 0,
		showCursor: false,
		cursorChar: "|",
		attr: null,
		contentType: 'html',
		onStringTyped: function() {
			setTimeout(function(){
				if(TUTORIAL_SCENES[step].action){
					tutorial_action(step);
				} else {
					tutorial(step+1);
				}
			}, 5000);
		}
	});
};

function tutorial_action(i){
	tutorial_mode = true;
	$('#judge-text').typed('reset'); $('#judge-text').text('...');

	$("#judge-text").typed({
		strings: [TUTORIAL_SCENES[i].action_text],
		stringsElement: null,
		typeSpeed: 40,
		startDelay: 1200,
		backSpeed: 20,
		backDelay: 500,
		loop: false,
		loopCount: 0,
		showCursor: false,
		cursorChar: "|",
		attr: null,
		contentType: 'html',
		onStringTyped: function() {
			setTimeout(function(){
				tutorial_step = i+1;
				$('#judge').css('opacity','0');
				setTimeout(function(){
					$('#judge').css('display','none');
					if(i == 1){
						document.getElementsByClassName('block-tutorial')[7].style.bottom = '10px';
					} else if(i == 2){
						document.getElementsByClassName('block-tutorial')[0].style.bottom = '10px';
					} else if(i == 8){
						drawTutorialMenu();
						for(var l in TUTORIAL_MAP){
							if(getMapCollision(document.getElementById('tutorial-'+l), document.getElementById('tutorial-'+_hero_chosed_tile)) == true && TUTORIAL_MAP[l].movable == true){
								tutorial_enemy_tile = l;
								TUTORIAL_MAP[l].hero = true;
								TUTORIAL_MAP[l].movable = false;
								TUTORIAL_MAP[l].hero_by_player = 'tutorial_enemy';
								TUTORIAL_MAP[l].heroType = 3;
								TUTORIAL_MAP[l].hero_number = heroes-1;

								var x, y;
								x = document.getElementById('tutorial-'+l).transform.animVal[0].matrix.e+8;
								y = document.getElementById('tutorial-'+l).transform.animVal[0].matrix.f+11.5;

								document.getElementsByTagName('svg')[1].innerHTML = document.getElementsByTagName('svg')[1].innerHTML + '<image overflow="visible" id="hero-'+l+'-'+3+'" width="100" height="100" xlink:href="assets/map/player2.png" style="pointer-events:none;" transform="matrix(0.24 0 0 0.24 '+x+' '+y+')">';
								break;
							}
						}
					} else if(i == 10){
						document.getElementsByClassName('block-tutorial')[7].style.bottom = '-60px'; // Q
						document.getElementsByClassName('block-tutorial')[10].style.bottom = '10px'; // M
					} else if(i == 11){
						tutorial_mode = false;
						tutorial_step = null;
						you_heroes = null;
						used_q = false;
						hero_chosed = false;
						hero_chose = null;
						_hero_chosed = false;
						_hero_chosed_tile = '';
						_hero_move = false;
						_hero_type = null;

						document.getElementsByClassName('block-tutorial')[0].style.bottom = '-60px'; // C
						document.getElementsByClassName('block-tutorial')[1].style.bottom = '-60px'; // 1
						document.getElementsByClassName('block-tutorial')[2].style.bottom = '-60px'; // 2
						document.getElementsByClassName('block-tutorial')[3].style.bottom = '-60px'; // 3
						document.getElementsByClassName('block-tutorial')[4].style.bottom = '-60px'; // 4
						document.getElementsByClassName('block-tutorial')[5].style.bottom = '-60px'; // 5
						document.getElementsByClassName('block-tutorial')[6].style.bottom = '-60px'; // 6
						document.getElementsByClassName('block-tutorial')[7].style.bottom = '-60px'; // Q
						document.getElementsByClassName('block-tutorial')[8].style.bottom = '-60px'; // W
						document.getElementsByClassName('block-tutorial')[9].style.bottom = '-60px'; // E
						document.getElementsByClassName('block-tutorial')[10].style.bottom = '-60px'; // M

						VK.api('storage.set', {key: "tutorial_complited1", value: "1"}, function(response1){
							VK.api('storage.get', {key: "all_users", global: true}, function(response2){
								VK.api('storage.set', {key: "all_users", global: true, value: (response2.response+1)*1}, function(response3){
									to_menu('menu');
								});
							});
						});
					}
				}, 500);
			}, 5000);
		}
	});
};